---
# Deploy Traefik with Docker Compose

- name: Ensure apache2-utils (for htpasswd) is installed
  become: true
  package:
    name: "{{ item }}"
    state: present
  with_items:
    - apache2-utils  # Debian/Ubuntu
  ignore_errors: true  # Allow to continue if one package manager fails
  
- name: Check if Traefik password file exists
  stat:
    path: "{{ traefik_dir }}/.traefik_password_set"
  register: traefik_password_file

- name: Load password from file if exists
  slurp:
    src: "{{ traefik_dir }}/.traefik_password_set"
  register: traefik_password_slurp
  when: traefik_password_file.stat.exists

- name: Set password from saved file
  set_fact:
    traefik_dashboard_password: "{{ traefik_password_slurp['content'] | b64decode | trim }}"
  when: traefik_password_file.stat.exists and traefik_password_slurp is defined

- name: Check if Traefik dashboard password is provided
  pause:
    prompt: "Enter a password for the Traefik dashboard user '{{ traefik_dashboard_username }}'"
  register: traefik_password_prompt
  no_log: true
  when: 
    - traefik_dashboard_auth_enabled 
    - traefik_dashboard_password == ""
    - not traefik_password_file.stat.exists

- name: Set dashboard password from prompt
  set_fact:
    traefik_dashboard_password: "{{ traefik_password_prompt.user_input }}"
  no_log: true
  when: 
    - traefik_dashboard_auth_enabled 
    - traefik_dashboard_password == "" 
    - traefik_password_prompt.user_input is defined
    - not traefik_password_file.stat.exists

- name: Generate Traefik dashboard password hash with htpasswd
  shell: "htpasswd -nbB {{ traefik_dashboard_username }} {{ traefik_dashboard_password }} | sed -e s/\\$/\\$\\$/g"
  register: htpasswd_result
  when: traefik_dashboard_auth_enabled and traefik_dashboard_password != ""
  no_log: true
  changed_when: false

- name: Set htpasswd hash
  set_fact:
    traefik_auth_users: "{{ htpasswd_result.stdout }}"
  when: traefik_dashboard_auth_enabled and traefik_dashboard_password != ""
  no_log: true
  
- name: Save password to file
  copy:
    content: "{{ traefik_dashboard_password }}"
    dest: "{{ traefik_dir }}/.traefik_password_set"
    mode: '0600'
  when: 
    - traefik_dashboard_auth_enabled
    - traefik_dashboard_password != ""
    - not traefik_password_file.stat.exists

- name: Create Traefik directory
  file:
    path: "{{ traefik_dir }}"
    state: directory
    mode: '0755'

- name: Create Traefik network
  community.docker.docker_network:
    name: traefik_network
    driver: bridge

- name: Ensure acme.json exists with correct permissions
  file:
    path: "{{ traefik_dir }}/{{ traefik_acme_file }}"
    state: touch
    mode: '0600'

- name: Deploy Traefik compose file
  template:
    src: traefik-compose.yml.j2
    dest: "{{ traefik_dir }}/docker-compose.yml"
    mode: '0644'

- name: Create hello world demo content
  file:
    path: "{{ traefik_dir }}/hello"
    state: directory
    mode: '0755'

- name: Create hello world index.html
  copy:
    content: |
      <!DOCTYPE html>
      <html>
      <head>
        <title>Hello from Traefik!</title>
        <style>
          body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
          h1 { color: #336699; }
        </style>
      </head>
      <body>
        <h1>Hello World!</h1>
        <p>Your Traefik reverse proxy is working correctly.</p>
        <p>Domain: hello.{{ domain }}</p>
      </body>
      </html>
    dest: "{{ traefik_dir }}/hello/index.html"
    mode: '0644'

- name: Launch Traefik stack
  community.docker.docker_compose_v2:
    project_src: "{{ traefik_dir }}"
    state: present 