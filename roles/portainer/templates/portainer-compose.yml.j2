services:
  portainer:
    image: {{ portainer_image }}
    container_name: portainer
    restart: always
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik_network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    ports:
      - "{{ portainer_port }}:9000"
      - "8000:8000"
{% if portainer_admin_password != "" %}
    command: --admin-password '{{ portainer_escaped_hash }}'
{% endif %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portainer.rule=Host(`{{ portainer_subdomain }}.{{ domains[0].domain }}`)"
      - "traefik.http.routers.portainer.entrypoints=websecure"
      - "traefik.http.routers.portainer.tls.certresolver=le"
      - "traefik.http.services.portainer.loadbalancer.server.port={{ portainer_port }}"

  # Portainer Agent - uncomment to use across multiple nodes
  agent:
    image: {{ portainer_agent_image }}
    container_name: portainer-agent
    restart: always
    networks:
      - traefik_network
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
      - /:/host
    ports:
      - "{{ portainer_agent_port }}:9001"
    environment:
      - LOG_LEVEL=INFO

volumes:
  portainer_data:
    external: true

networks:
  traefik_network:
    external: true 